#!/usr/bin/env bash

# zdev - Start a Zellij development session with different layout options

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LAYOUTS_DIR="$HOME/.config/zellij/layouts"

show_help() {
    cat << EOF
Usage: zdev [OPTION] [SESSION_NAME]

Start a Zellij development session with predefined layouts.

Options:
  -l, --layout LAYOUT    Use specific layout (default: dev)
  -h, --help            Show this help message
  -a, --attach          Attach to existing session if it exists
  -d, --detach          Start session in detached mode
  --list-layouts        List available layouts

Available layouts:
  default               Single terminal pane
  dev                  Editor (67%) + Claude (33%) vertical split
  dev-full             Editor + logs (horizontal) + Claude (33% right)
  dev-horizontal       Editor (60% top) + Claude/terminal (bottom split)

Examples:
  zdev                  # Start with 'dev' layout, session name 'main'
  zdev -l dev-full      # Start with dev-full layout
  zdev -a myproject     # Attach to 'myproject' session or create if not exists
  zdev --list-layouts   # Show all available layouts
EOF
}

list_layouts() {
    echo "Available layouts:"
    if [[ -d "$LAYOUTS_DIR" ]]; then
        for layout in "$LAYOUTS_DIR"/*.kdl; do
            if [[ -f "$layout" ]]; then
                basename "$layout" .kdl
            fi
        done
    else
        echo "No layouts directory found at $LAYOUTS_DIR"
    fi
}

main() {
    local layout="dev"
    local session_name="main"
    local attach=false
    local detach=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            -l|--layout)
                layout="$2"
                shift 2
                ;;
            -a|--attach)
                attach=true
                shift
                ;;
            -d|--detach)
                detach=true
                shift
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            --list-layouts)
                list_layouts
                exit 0
                ;;
            -*)
                echo "Unknown option: $1" >&2
                show_help >&2
                exit 1
                ;;
            *)
                session_name="$1"
                shift
                ;;
        esac
    done
    
    # Check if layout exists
    if [[ ! -f "$LAYOUTS_DIR/$layout.kdl" ]]; then
        echo "Error: Layout '$layout' not found at $LAYOUTS_DIR/$layout.kdl" >&2
        echo "Available layouts:"
        list_layouts
        exit 1
    fi
    
    local zellij_args=(
        "--layout" "$layout"
        "--session" "$session_name"
    )
    
    if [[ "$attach" == true ]]; then
        # Try to attach, if session doesn't exist, create it
        if zellij list-sessions | grep -q "^$session_name\$"; then
            zellij attach "$session_name"
        else
            zellij "${zellij_args[@]}"
        fi
    else
        zellij "${zellij_args[@]}"
    fi
}

main "$@"